# ロボット軌跡可視化手順

## 1. 関連ファイル
- `lerobot/src/lerobot/scripts/lerobot_record.py`：ポリシー無し時に `attn_videos/episode_values_*.json` と `all_cameras_episode_*.mp4` を保存するランチャー。関節角ログ＋2カメラ結合動画）を出力する
- `lerobot/src/lerobot/scripts/fk_image_calibration.py`：`lerobot/src/lerobot/scripts/SO101/fk_image.conf` を生成するキャリブレーションツール。`affine_matrix` のみを保存。
- `lerobot/src/lerobot/scripts/visualize_inference_trajectory.py`：指定されたデータセットと`fk_image.conf` を使って計画軌跡を動画にオーバーレイ。
- `lerobot/src/lerobot/scripts/SO101/fk_image.conf`：クリックで得た画像座標と FK の XY から推定した 2x3 アフィン変換行列。

## 2. 利用手順とコマンド例

### 2.1 画像上の FK↔画素対応キャリブレーション
```bash
uv run python lerobot/src/lerobot/scripts/fk_image_calibration.py \
  --dataset-root dataset/calibration_v1 \
  --episode 0
```
- `attn_videos/episode_values_0.json` を読み、クリックで EE 画素位置を対応付け。
- `lerobot/src/lerobot/scripts/SO101/fk_image.conf` に `affine_matrix` を保存。

### 2.2 軌跡可視化オーバーレイ
```bash
uv run python lerobot/src/lerobot/scripts/visualize_inference_trajectory.py \
  --dataset-root dataset/eval_test \
  --episode 0
```
- `SO101/fk_image.conf` を読み込み、計画軌跡を動画に赤線で描画。過去の軌跡は古いほど薄く残り、現在のステップ位置を緑点で表示。
- 出力先: `dataset/eval_test/attn_videos/plan_overlay_episode_0.mp4`（デフォルトサフィックス）。

## 4. ポイント
- `fk_image.conf` は常に `lerobot/src/lerobot/scripts/SO101/` を参照する前提。
- URDF 関節名と `ACTION_KEYS` の対応を名前ベースでマッピングするよう修正済み。
- 可視化の透明度は `visualize_inference_trajectory.py` の `base_alpha`, `min_alpha` で調整可能。
