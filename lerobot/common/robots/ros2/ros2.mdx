# ROS 2

This guide illustrates how to integrate ros2_control or MoveIt2 compatible robots with LeRobot.
For now, a single robot arm with a 1-DoF gripper is supported.

## Overview

**Supported control modes:**
- âœ… Joint position via ros2_control
- âœ… Cartesian velocity via MoveIt2
- ðŸš§ End-effector pose (coming soon)

This integration allows you to use LeRobot's full range of features with your robot, including teleoperation, recording, and replay.
A basic understanding of ROS 2, ros2_control, and MoveIt2 is required.
Your robot should already be configured to work with these frameworks.

## Prerequisites

### System Requirements

Before getting started, ensure you have the following installed:

- [ROS 2 Jazzy](https://docs.ros.org/en/jazzy/Installation.html)
  - Older ROS 2 versions will still work but cartesian velocity control will be broken.
- [MoveIt2](https://moveit.ai/install-moveit2/binary) if cartesian velocity control is desired

For joint position control, the robot should be configured with the following:
- `position_controllers/JointGroupPositionController` for the robot arm joints
- `position_controllers/GripperActionController` for the gripper
- `joint_state_broadcaster/JointStateBroadcaster` for joint state feedback

For cartesian velocity control, the robot should be configured with the same gripper and state feedback as above, and additionally:
- `joint_trajectory_controller/JointTrajectoryController` for robot arm control
- `moveit_servo` node for real-time control

LeRobot should run in a virtual environment that has the same Python version as your ROS 2 distribution, i.e for jazzy, Python 3.12 should be used:
```bash
uv venv --python 3.12 && source .venv/bin/activate
source /opt/ros/jazzy/setup.bash
```

### Robot Setup

Your robot must be properly configured and working with MoveIt2 before integration:

- âœ… MoveIt2 configuration package exists for your robot
- âœ… `move_group` and `moveit_servo` nodes can be launched successfully
- âœ… Robot is calibrated and ready for operation

See [AR4 ROS Driver](https://github.com/ycheng517/ar4_ros_driver) for an example of a MoveIt2-enabled robot that works with LeRobot.

## Configuration

Create a config class for your robot by sub-classing `ROS2Config`.
You may override joint names, gripper configurations, and other parameters as needed.
An example config class for velocity control may look like this:

```python
from dataclasses import dataclass, field
from lerobot.common.robots.config import RobotConfig
from lerobot.common.robots.ros2.config_ros2 import ROS2Config, ROS2InterfaceConfig

@RobotConfig.register_subclass("my_ros2_robot")
@dataclass
class MyRobotConfig(ROS2Config):
    action_type: ActionType = ActionType.JOINT_VELOCITY

    ros2_interface: ROS2InterfaceConfig = field(
        default_factory=lambda: ROS2InterfaceConfig(
            base_link="base_link",
            arm_joint_names=[
                "joint_1",
                "joint_2",
                "joint_3",
                "joint_4",
                "joint_5",
                "joint_6",
            ],
            gripper_joint_name="gripper_joint",
            gripper_open_position=0.0,
            gripper_close_position=1.0,
            max_linear_velocity=0.05,  # m/s
            max_angular_velocity=0.25,  # rad/s
        )
    )
```

## Getting Started

The following steps will guide you through launching your robot and performing keyboard teleoperation with cartesian velocity control.

### Step 1: Launch Your Robot

Start your ROS2-enabled robot stack.
The exact commands depend on your robot model and configuration.

**Example: [Annin Robotics AR4](https://github.com/ycheng517/ar4_ros_driver)**
```bash
# Launch the robot driver and ros2_control controllers
ros2 launch annin_ar4_driver driver.launch.py ar_model:=mk1 calibrate:=True

# Launch MoveIt2 with Moveit Servo enabled
ros2 launch annin_ar4_moveit_config moveit.launch.py ar_model:=mk1 moveit_servo:=True
```

### Step 2: Teleoperation (with keyboard)

Once your robot is launched and ready, you can teleoperate it using keyboard controls:

```bash
# Source the ROS environment
source /opt/ros/jazzy/setup.bash

python -m lerobot.teleoperate \
    --robot.type=my_robot \
    --robot.id=my_robot_arm \
    --robot.action_from_keyboard=True \
    --teleop.type=keyboard \
    --teleop.id=keyboard_controller \
    --display_data=true
```

#### Control Mapping (For Cartesian Velocity Control)

The default keyboard mapping provides intuitive control:

| Key | Action |
|-----|--------|
| `A/D` | Move left/right (X-axis) |
| `W/S` | Move backward/forward (Y-axis) |
| `N/M` | Move down/up (Z-axis) |
| `I/K` | Rotate around X-axis |
| `J/L` | Rotate around Y-axis |
| `U/O` | Rotate around Z-axis |
| `Space` | Close gripper (hold to close) |

> **Note**: The gripper closes when Space is held down, and opens when released. All movements are velocity-based and stop when keys are released.

### Next Steps

Once you have teleoperation working, you can use all standard LeRobot features as usual:

- Incorporate cameras and other sensors
- Use `lerobot.record` to collect demonstration datasets
- Use `lerobot.replay` to test recorded trajectories
- Train policies on your robot's data
